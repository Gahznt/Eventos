{# src/layouts/base.html.twig #}
{% extends 'base.html.twig' %}
{% block body %}

    <div class="container">
        <div class="fieldset">
            <h2>{{ 'USERLIST_FILTERS'|trans }}</h2>
            <div class="form mb-3">
                {{ form_start(form) }}
                <div class="col-6 col-md-2 form-group">
                    <label for="since">{{ 'USERLIST_UPDATED_SINCE'|trans }}</label>
                    {{ form_widget(form.since, {'attr': {'id':'since', 'class': 'filter form-control date'}}) }}
                </div>

                <div class="col-6 col-md-2 form-group">
                    <label for="thru">{{ 'USERLIST_UPDATED_UNTIL'|trans }}</label>
                    {{ form_widget(form.thru, {'attr': {'id':'thru', 'class': 'filter form-control date'}}) }}
                </div>

                <div class="col-6 col-md-2 form-group">
                    <label for="levels">{{ 'Level'|trans }}</label>
                    {{ form_widget(form.levels, {'attr': {'id':'levels', 'class': 'filter form-control'}}) }}
                </div>

                <div class="col-6 col-md-2 form-group">
                    <label for="payment">{{ 'Payment'|trans }}</label>
                    {{ form_widget(form.payment, {'attr': {'id':'payment', 'class': 'filter form-control'}}) }}
                </div>

                <div class="col-6 col-md-2 form-group">
                    <label for="paymentDays">{{ 'USERLIST_LAST_PAYMENT'|trans }}</label>
                    {{ form_widget(form.paymentDays, {'attr': {'id':'paymentDays', 'class': 'filter form-control'}}) }}
                </div>

                <div class="col-6 col-md-2 form-group">
                    <label for="search">{{ 'Search'|trans }}</label>
                    <a id="userFormSearchBtn" class="inputSearchBtn"><i class="fas fa-search"></i></a>
                    {{ form_widget(form.search, {'attr': {'id':'search', 'class': 'filter form-control'}}) }}
                </div>
                {{ form_end(form) }}
            </div>

            <div class="tabela table-responsive">
                <h2>{{ 'USERLIST_FOUND'|trans }}</h2>
                {% if users is empty %}
                    {% if isFormSubmitted %}
                        <div class="alert alert-warning" role="alert">
                            {{ 'Nenhum resultado encontrado.'|trans }}
                        </div>
                    {% else %}
                        <div class="alert alert-primary" role="alert">
                            {{ 'Faça uma Busca para listar os Usuários.'|trans }}
                        </div>
                    {% endif %}
                {% else %}
                    <table class="table table-striped table-sm">
                        <thead>
                        <tr>
                            <th class="sort desc">Id</th>
                            <th class="sort">{{ 'Change'|trans }}</th>
                            <th class="sort">{{ 'Nome'|trans }}</th>
                            <th class="sort">{{ 'Level'|trans }}</th>
                            <th class="sort">{{ 'Payment'|trans }}</th>
                            <th class="sort">{{ 'USER_EXPIRE_DATE'|trans }}</th>
                            <th class="sort">{{ 'Last'|trans }} {{ 'Payment'|trans }}</th>
                            <th>{{ 'Actions'|trans }}</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for user in users %}
                            {% set level = 0 %}
                            {% set statusPay = 0 %}
                            {% set updatedAt = "" %}
                            {% set expiredAt = "" %}
                            {% set lastPay = "" %}
                            {% for association in user.associations %}
                                {% if loop.last %}
                                    {% set level = association.level %}
                                    {% set statusPay = association.statusPay %}
                                    {% set updatedAt = association.updatedAt %}
                                    {% set expiredAt = association.expiredAt %}
                                    {% set lastPay = association.lastPay %}
                                {% endif %}
                            {% endfor %}
                            <tr>
                                <td>{{ user.id }}</td>
                                <td>{{ user.updatedAt is empty ? "": user.updatedAt|format_datetime('short', 'none') }}</td>
                                <td>{{ user.name }}</td>
                                <td class="text-center">
                                    <span class="badge badge-{{ level|nivel_associacao('color') }}">
                                      {{ level|nivel_associacao('label')|trans }}
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span class="badge badge-outline badge-{{ statusPay|status_pagamento('color') }}">
                                      {{ statusPay|status_pagamento('label')|trans }}
                                        <i class="ml-1 fas fa-{{ statusPay|status_pagamento('icon') }}"></i>
                                    </span>
                                </td>
                                <td>{{ expiredAt is empty ? "" : expiredAt|format_datetime('short', 'none') }} </td>
                                <td>{{ lastPay is empty ? "" : lastPay|format_datetime('short', 'none') }} </td>
                                <td>
                                    <a href="{{ path('user_show' , {id: user.id }) }}" data-toggle="tooltip"
                                       class="hover-success" title="{{ 'TOOLTIP_USER_DATA'|trans }}">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a data-toggle="tooltip" class="hover-success ml-1 setClipboard"
                                       title="{{ 'TOOLTIP_MAIL_COPY'|trans }}" data-value="{{ user.email }}">
                                        <i class="fas fa-envelope"></i>
                                    </a>
                                    <a class="hover-danger ml-1 tdDel"
                                       data-path="{{ path('user_delete', {'id': user.id}) }}"
                                       data-token="{{ csrf_token('delete' ~ user.id) }}" data-action="remove"
                                       data-confirm="{{ 'TOOLTIP_USER_DELETE'|trans }} {{ user.name }}?">
                                        <i class="fas fa-times"></i>
                                    </a>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    <nav class="d-flex justify-content-between" style="float: right">
                        {{ knp_pagination_render(users) }}
                    </nav>
                    <small class="text-muted">{{ 'Showing'|trans }} {{ users|length }} {{ 'of' |trans }} {{ users.getTotalItemCount }}</small>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {{ encore_entry_script_tags('user') }}
{% endblock %}
